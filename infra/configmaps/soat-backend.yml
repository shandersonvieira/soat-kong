apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-service-backend-config
  namespace: kong-service
  labels:
    app: kong-service-backend
    tier: backend
  annotations:
    maintainer: "SOAT - Grupo 75"
    description: "ConfigMap com vari√°veis de ambiente para o backend"
data:
  kong.yml: |
    _format_version: "3.0"
    _transform: true

    services:
      - name: customers
        host: customer-service-backend.customer-service.svc.cluster.local
        port: 80
        protocol: http
        connect_timeout: 60000
        write_timeout: 60000
        read_timeout: 60000
        retries: 5
        enabled: true

        routes:
          - name: Customers
            paths:
              - /customers
            methods: ["GET", "POST"]
            protocols: ["http", "https"]
            strip_path: false
            preserve_host: false
            https_redirect_status_code: 426
            path_handling: v1
            request_buffering: true
            response_buffering: true

      - name: products
        host: products-app.products.svc.cluster.local
        port: 80
        protocol: http
        connect_timeout: 60000
        write_timeout: 60000
        read_timeout: 60000
        retries: 5
        enabled: true

        routes:
          - name: Products
            paths:
              - /products
            methods: ["GET", "POST", "PUT", "DELETE"]
            protocols: ["http", "https"]
            strip_path: false
            preserve_host: false
            https_redirect_status_code: 426
            path_handling: v1
            request_buffering: true
            response_buffering: true

      - name: tokens
        host: auth-service-backend.auth-service.svc.cluster.local
        port: 80
        protocol: http
        connect_timeout: 60000
        write_timeout: 60000
        read_timeout: 60000
        retries: 5
        enabled: true

        routes:
          - name: tokens
            paths:
              - /tokens
            methods: ["GET", "POST"]
            protocols: ["http", "https"]
            strip_path: false
            preserve_host: false
            https_redirect_status_code: 426
            path_handling: v1
            request_buffering: true
            response_buffering: true

    plugins:
      - name: jwt
        enabled: true
        service: customers
        config:
          secret_is_base64: false
          cookie_names: []
          header_names: ["authorization"]
          key_claim_name: iss
          claims_to_verify: null
          maximum_expiration: 0
          run_on_preflight: true
          anonymous: null
          uri_param_names: ["jwt"]

      - name: jwt
        enabled: true
        service: products
        config:
          secret_is_base64: false
          cookie_names: []
          header_names: ["authorization"]
          key_claim_name: iss
          claims_to_verify: null
          maximum_expiration: 0
          run_on_preflight: true
          anonymous: null
          uri_param_names: ["jwt"]

    consumers:
      - username: python-auth

    jwt_secrets:
      - consumer: python-auth
        key: "auth_service"
        secret: "${SOAT_JWT_SECRET}"
        algorithm: "HS256"
